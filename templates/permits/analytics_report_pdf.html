{% load report_extras %}
{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    .header { text-align: center; margin-bottom: 20px; }
    .logo { width: 80px; margin-bottom: 10px; }
    .section { margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    th, td { border: 1px solid #888; padding: 6px; text-align: left; }
    th { background: #f2c879; }
    tr:nth-child(even) { background: #f9f9f9; }
    .footer { text-align: center; font-size: 0.9em; color: #888; margin-top: 30px; }
    .meta { margin-bottom: 10px; font-size: 1em; }
    h2, h3 { color: #4b3c10; }
  </style>
</head>
<body>
  <div class="header">
    <img src="{% static 'permits/muranga_logo.jpg' %}" class="logo" alt="Muranga County Logo"/>
    <h2>Muranga County Coffee Distribution Report</h2>
    <div class="meta">
      <p>Date: {{ generation_date|date:"Y-m-d H:i" }}</p>
      {% if society_name %}
        <p>Society: <strong>{{ society_name }}</strong></p>
      {% endif %}
      <p>Period: {{ start_date }} to {{ end_date }}</p>
      <p>Granularity: {{ granularity|title }}</p>
    </div>
  </div>

  {% if top_factories and top_factories|length > 0 %}
    <div class="section">
      <h3>Top Coffee Factories</h3>
      <table>
        <tr>
          <th>Factory</th>
          <th>Total Coffee (kg)</th>
        </tr>
        {% for row in top_factories %}
        <tr>
          <td>{{ row.factory }}</td>
          <td>{{ row.totalKg|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
  {% endif %}

  {% if top_societies and top_societies|length > 0 %}
    <div class="section">
      <h3>Top Coffee Movers (Societies)</h3>
      <table>
        <tr>
          <th>Society</th>
          <th>Total Coffee (kg)</th>
        </tr>
        {% for row in top_societies %}
        <tr>
          <td>{{ row.society }}</td>
          <td>{{ row.totalKg|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
  {% endif %}

  {% if top_grades and top_grades|length > 0 %}
    <div class="section">
      <h3>Top Coffee Grades</h3>
      <table>
        <tr>
          <th>Grade</th>
          <th>Total Coffee (kg)</th>
        </tr>
        {% for row in top_grades %}
        <tr>
          <td>{{ row.grade }}</td>
          <td>{{ row.totalKg|floatformat:2 }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
  {% endif %}

  {% if total_coffee and total_coffee|length > 0 %}
    <div class="section">
      <h3>Total Coffee Moved</h3>
      <table>
        <tr>
          <th>Period</th>
          {% for grade in all_grades %}
            <th>{{ grade }}</th>
          {% endfor %}
        </tr>
        {% for row in total_coffee %}
        <tr>
          <td>{{ row.period }}</td>
          {% for grade in all_grades %}
            <td>{{ row|get_item:grade|floatformat:2 }}</td>
          {% endfor %}
        </tr>
        {% endfor %}
      </table>
    </div>
  {% endif %}

  <div class="footer">
    Generated by Coffee Movement Permit System
  </div>
</body>
</html>
